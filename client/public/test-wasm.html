<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM Effect Integration Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #667eea;
            margin-top: 0;
        }

        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 5px;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        #console {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            white-space: pre-wrap;
        }

        .success {
            color: #00ff00;
        }

        .error {
            color: #ff4444;
        }

        .info {
            color: #00aaff;
        }

        .warning {
            color: #ffaa00;
        }

        pre {
            background: #2d2d2d;
            color: #e0e0e0;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin: 0 4px;
        }

        .badge-success {
            background: #28a745;
            color: white;
        }

        .badge-warning {
            background: #ffc107;
            color: #333;
        }

        .badge-info {
            background: #17a2b8;
            color: white;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üéõÔ∏è WASM Effect Integration Test</h1>

        <div class="test-section">
            <h2>üìä Status</h2>
            <p>
                <span class="badge badge-success">WASM Complete</span>
                <span class="badge badge-info">10 WASM Effects Ready</span>
                <span class="badge badge-success">SIMD Enabled</span>
            </p>
            <p>
                <strong>Dynamics:</strong> Compressor, Saturator, Limiter, Clipper<br>
                <strong>Spacetime:</strong> Reverb, Delay<br>
                <strong>Modulation:</strong> Chorus, Phaser, Panner<br>
                <strong>EQ:</strong> ThreeBandEQ<br>
                <strong>Implementation:</strong> Rust WASM + SIMD128 Optimized
            </p>
        </div>

        <div class="test-section">
            <h2>üß™ Quick Tests</h2>
            <p>Click buttons to run tests (check console for detailed output)</p>

            <button onclick="testBasicCreation()">Test 1: Create Effect</button>
            <button onclick="testParameters()">Test 2: Set Parameters</button>
            <button onclick="testMultipleEffects()">Test 3: Multiple Effects</button>
            <button onclick="testSerialization()">Test 4: Serialize/Restore</button>
            <button onclick="clearConsole()">Clear Console</button>

            <div id="console"></div>
        </div>

        <div class="test-section">
            <h2>üìù Manual Commands (Browser Console)</h2>
            <p>Open browser DevTools console (F12) and run:</p>

            <pre><code>// Create a WASM reverb effect
const ctx = new AudioContext();
const reverb = UnifiedEffect.create(ctx, 'modern-reverb');

// Check implementation
console.log(reverb.getMetadata());
// Should show: implementation: 'WasmEffectImpl'

// Set parameters
reverb.setParameter('size', 0.8);
reverb.setParameter('decay', 3.5);
reverb.setParameter('wet', 0.4);

// Get stats
console.log(reverb.getPerfStats());</code></pre>

            <h3>Run All Tests:</h3>
            <pre><code>await window.runAllTests();</code></pre>

            <h3>Run Benchmark:</h3>
            <pre><code>const result = await quickBenchmark('modern-reverb');
console.log(`CPU Improvement: ${result.renderTimeImprovement}%`);</code></pre>
        </div>

        <div class="test-section">
            <h2>‚ö†Ô∏è Note</h2>
            <p>
                If you see errors about WASM module not found, this is expected in dev mode without building the WASM
                module.
                The system will automatically fall back to Worklet implementation.
            </p>
            <p>
                <strong>To build WASM:</strong>
            </p>
            <pre><code>cd client/src/lib/wasm/dawg-audio-dsp
wasm-pack build --target web --release
cp pkg/*.wasm ../../../public/wasm/
cp pkg/*.js ../../../public/wasm/</code></pre>
        </div>
    </div>

    <script type="module">
        import { UnifiedEffect } from '/src/lib/audio/effects/unified/index.js';
        import { quickBenchmark } from '/src/lib/audio/testing/EffectBenchmark.js';

        // Make available globally
        window.UnifiedEffect = UnifiedEffect;
        window.quickBenchmark = quickBenchmark;

        const consoleDiv = document.getElementById('console');

        function log(message, className = 'info') {
            const line = document.createElement('div');
            line.className = className;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            consoleDiv.appendChild(line);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;

            // Also log to real console
            console.log(message);
        }

        window.clearConsole = () => {
            consoleDiv.innerHTML = '';
        };

        // Preload worklet modules for fallback support
        async function loadWorklets(ctx) {
            log('üîÑ Loading AudioWorklet modules...', 'info');
            try {
                // Manually load core worklets for testing
                const worklets = [
                    '/worklets/ModernReverbProcessor.js',
                    '/worklets/ModernDelayProcessor.js',
                    '/worklets/MultiBandEQProcessor.js'
                ];

                for (const path of worklets) {
                    try {
                        await ctx.audioWorklet.addModule(path);
                        log(`  ‚úÖ Loaded ${path}`);
                    } catch (e) {
                        // Ignore if already loaded
                        if (!e.message.includes('already')) {
                            log(`  ‚ö†Ô∏è Failed to load ${path}: ${e.message}`, 'warning');
                        }
                    }
                }
                log('‚úÖ Worklet modules ready', 'success');
            } catch (error) {
                log('‚ùå Worklet loading error: ' + error.message, 'error');
            }
        }

        window.testBasicCreation = async () => {
            log('üß™ Test 1: Basic Effect Creation', 'info');

            try {
                const ctx = new AudioContext();
                await loadWorklets(ctx); // Ensure worklets are loaded
                log('  ‚úÖ AudioContext created');

                const reverb = UnifiedEffect.create(ctx, 'modern-reverb');
                log('  ‚úÖ Effect created: ' + reverb.type);

                const metadata = reverb.getMetadata();
                log('  üìä Implementation: ' + metadata.implementation, 'success');
                log('  üìä WASM Supported: ' + metadata.wasmSupported, 'success');

                reverb.dispose();
                log('  ‚úÖ Effect disposed', 'success');
                log('‚úÖ Test 1 PASSED', 'success');

            } catch (error) {
                log('‚ùå Test 1 FAILED: ' + error.message, 'error');
                console.error(error);
            }
        };

        window.testParameters = async () => {
            log('üß™ Test 2: Parameter Management', 'info');

            try {
                const ctx = new AudioContext();
                await loadWorklets(ctx);
                const delay = UnifiedEffect.create(ctx, 'modern-delay');
                log('  ‚úÖ Delay effect created');

                // Set individual parameters
                delay.setParameter('timeLeft', 0.5);
                delay.setParameter('feedbackLeft', 0.7);
                delay.setParameter('wet', 0.4);
                log('  ‚úÖ Parameters set individually');

                // Verify
                const timeLeft = delay.getParameter('timeLeft');
                log(`  üìä timeLeft = ${timeLeft}`, 'success');

                // Batch update
                delay.setParametersState({
                    timeLeft: 0.375,
                    timeRight: 0.5,
                    feedbackLeft: 0.6,
                    wet: 0.5
                });
                log('  ‚úÖ Batch parameters updated');

                const state = delay.getParametersState();
                log('  üìä Final state: ' + JSON.stringify(state).substring(0, 100) + '...', 'success');

                delay.dispose();
                log('‚úÖ Test 2 PASSED', 'success');

            } catch (error) {
                log('‚ùå Test 2 FAILED: ' + error.message, 'error');
                console.error(error);
            }
        };

        window.testMultipleEffects = async () => {
            log('üß™ Test 3: Multiple Effects', 'info');

            try {
                const ctx = new AudioContext();
                await loadWorklets(ctx);
                const effects = [];

                // Create multiple effects
                const types = ['modern-reverb', 'modern-delay', 'multiband-eq'];

                for (const type of types) {
                    const effect = UnifiedEffect.create(ctx, type);
                    effects.push(effect);
                    log(`  ‚úÖ Created: ${type}`);
                }

                log(`  üìä Total effects created: ${effects.length}`, 'success');

                // Cleanup
                effects.forEach(fx => fx.dispose());
                log('  ‚úÖ All effects disposed');

                log('‚úÖ Test 3 PASSED', 'success');

            } catch (error) {
                log('‚ùå Test 3 FAILED: ' + error.message, 'error');
                console.error(error);
            }
        };

        window.testSerialization = async () => {
            log('üß™ Test 4: Serialization', 'info');

            try {
                const ctx = new AudioContext();
                await loadWorklets(ctx);
                const effect = UnifiedEffect.create(ctx, 'modern-reverb');

                // Set parameters
                effect.setParametersState({
                    size: 0.9,
                    decay: 5.0,
                    wet: 0.5
                });
                log('  ‚úÖ Parameters set');

                // Serialize
                const serialized = effect.serialize();
                log('  ‚úÖ Effect serialized');
                log('  üìä Serialized data: ' + JSON.stringify(serialized).substring(0, 100) + '...', 'info');

                // Create new effect and restore
                const restored = UnifiedEffect.create(ctx, serialized.type);
                restored.setParametersState(serialized.parameters);
                log('  ‚úÖ Effect restored from serialized data');

                // Verify
                const restoredState = restored.getParametersState();
                log('  üìä Restored size: ' + restoredState.size, 'success');

                effect.dispose();
                restored.dispose();
                log('‚úÖ Test 4 PASSED', 'success');

            } catch (error) {
                log('‚ùå Test 4 FAILED: ' + error.message, 'error');
                console.error(error);
            }
        };

        window.runAllTests = async () => {
            log('üöÄ Running All Tests...', 'info');
            log('================================', 'info');

            await testBasicCreation();
            await new Promise(resolve => setTimeout(resolve, 500));

            await testParameters();
            await new Promise(resolve => setTimeout(resolve, 500));

            await testMultipleEffects();
            await new Promise(resolve => setTimeout(resolve, 500));

            await testSerialization();

            log('================================', 'info');
            log('üéâ All Tests Complete!', 'success');
        };

        // Initial message
        log('üéõÔ∏è WASM Effect Test Page Loaded', 'success');
        log('üìù Click buttons above or use browser console', 'info');
        log('üí° Tip: Open DevTools (F12) for detailed logs', 'info');
    </script>
</body>

</html>