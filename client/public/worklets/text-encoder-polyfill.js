// Polyfill for TextDecoder and TextEncoder in AudioWorklet scope
// Required for WASM modules generated by wasm-pack

const globalScope = typeof globalThis !== 'undefined' ? globalThis : (typeof self !== 'undefined' ? self : this);

if (typeof globalScope.TextDecoder === 'undefined') {
    globalScope.TextDecoder = class TextDecoder {
        constructor(encoding = 'utf-8', options = {}) {
            this.encoding = encoding;
            this.ignoreBOM = options.ignoreBOM || false;
            this.fatal = options.fatal || false;
        }

        decode(buffer, options = {}) {
            if (!buffer) return '';

            const bytes = new Uint8Array(buffer);
            let str = '';

            // Simple implementation: assumes ASCII/Latin1 for now
            // This is usually sufficient for WASM panic messages and basic logging
            // For full UTF-8 support, a more complex polyfill would be needed
            for (let i = 0; i < bytes.length; i++) {
                str += String.fromCharCode(bytes[i]);
            }

            return str;
        }
    };
    console.log('✅ TextDecoder polyfill loaded');
}

if (typeof globalScope.TextEncoder === 'undefined') {
    globalScope.TextEncoder = class TextEncoder {
        constructor(encoding = 'utf-8') {
            this.encoding = encoding;
        }

        encode(str) {
            if (!str) return new Uint8Array(0);

            const bytes = new Uint8Array(str.length);
            for (let i = 0; i < str.length; i++) {
                bytes[i] = str.charCodeAt(i);
            }
            return bytes;
        }
    };
    console.log('✅ TextEncoder polyfill loaded');
}
