<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéöÔ∏è VASynth v2 - Modulation Demo (Wobble Bass!)</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
      color: white;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      font-size: 3em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .subtitle {
      text-align: center;
      font-size: 1.2em;
      opacity: 0.9;
      margin-bottom: 30px;
    }

    .panel {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .panel h2 {
      margin-bottom: 16px;
      font-size: 1.5em;
    }

    button {
      background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      border-radius: 8px;
      margin: 5px;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    button.playing {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .control-group {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 16px;
    }

    .control-group h3 {
      font-size: 0.9em;
      margin-bottom: 12px;
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .slider-container {
      margin-bottom: 16px;
    }

    .slider-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.9em;
    }

    .slider-value {
      font-weight: bold;
      color: #ffd700;
    }

    input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: rgba(255, 255, 255, 0.2);
      outline: none;
      -webkit-appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .visualizer {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 16px;
      height: 200px;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .lfo-display {
      width: 100%;
      height: 100%;
      position: relative;
    }

    canvas {
      width: 100%;
      height: 100%;
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
    }

    .metric {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }

    .metric-value {
      font-size: 2em;
      font-weight: bold;
      color: #ffd700;
      margin-bottom: 4px;
    }

    .metric-label {
      font-size: 0.8em;
      opacity: 0.8;
    }

    .demo-note {
      background: rgba(255, 255, 255, 0.1);
      border-left: 4px solid #ffd700;
      padding: 16px;
      border-radius: 8px;
      margin-top: 16px;
    }

    .demo-note strong {
      color: #ffd700;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéöÔ∏è Modulation System Demo</h1>
    <p class="subtitle">LFO-controlled Filter Wobble - Dubstep/Bass Music</p>

    <!-- Init -->
    <div class="panel">
      <h2>System Status</h2>
      <button id="init-btn">üöÄ Initialize Modulation Demo</button>
      <button id="start-wobble-btn" disabled>‚ñ∂Ô∏è Start Wobble Bass</button>
      <button id="stop-wobble-btn" disabled>‚è∏Ô∏è Stop</button>
    </div>

    <!-- Presets -->
    <div class="panel">
      <h2>üé® Wobble Presets</h2>
      <button id="preset-slow" disabled>Slow Wobble (1 Hz)</button>
      <button id="preset-medium" disabled>Medium Wobble (2 Hz)</button>
      <button id="preset-fast" disabled>Fast Wobble (4 Hz)</button>
      <button id="preset-triplet" disabled>Triplet Wobble (1/8T)</button>

      <div class="demo-note">
        <strong>üí° Pro Tip:</strong> Classic dubstep uses 1-2 Hz wobble.
        Adjust LFO Rate and Depth below to create your own wobble patterns!
      </div>
    </div>

    <!-- LFO Controls -->
    <div class="panel">
      <h2>üåä LFO Controls</h2>
      <div class="controls">
        <div class="control-group">
          <h3>LFO 1 Settings</h3>
          <div class="slider-container">
            <div class="slider-label">
              <span>Rate (Hz)</span>
              <span class="slider-value" id="lfo-rate-val">2.0 Hz</span>
            </div>
            <input type="range" id="lfo-rate" min="0.1" max="10" value="2" step="0.1" disabled>
          </div>

          <div class="slider-container">
            <div class="slider-label">
              <span>Depth</span>
              <span class="slider-value" id="lfo-depth-val">80%</span>
            </div>
            <input type="range" id="lfo-depth" min="0" max="100" value="80" disabled>
          </div>

          <div class="slider-container">
            <div class="slider-label">
              <span>Waveform</span>
              <span class="slider-value" id="lfo-wave-val">Sine</span>
            </div>
            <select id="lfo-wave" disabled style="width: 100%; padding: 8px; background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 4px;">
              <option value="sine">Sine</option>
              <option value="triangle">Triangle</option>
              <option value="sawtooth">Sawtooth</option>
              <option value="square">Square</option>
            </select>
          </div>
        </div>

        <div class="control-group">
          <h3>Modulation Target</h3>
          <div class="slider-container">
            <div class="slider-label">
              <span>Base Filter Cutoff</span>
              <span class="slider-value" id="filter-base-val">800 Hz</span>
            </div>
            <input type="range" id="filter-base" min="200" max="5000" value="800" disabled>
          </div>

          <div class="slider-container">
            <div class="slider-label">
              <span>Modulation Amount</span>
              <span class="slider-value" id="mod-amount-val">+3000 Hz</span>
            </div>
            <input type="range" id="mod-amount" min="0" max="5000" value="3000" disabled>
          </div>

          <div class="slider-container">
            <div class="slider-label">
              <span>Filter Resonance</span>
              <span class="slider-value" id="filter-res-val">8.0</span>
            </div>
            <input type="range" id="filter-res" min="0.1" max="20" value="8" step="0.1" disabled>
          </div>
        </div>
      </div>
    </div>

    <!-- LFO Visualizer -->
    <div class="panel">
      <h2>üìä LFO Visualization</h2>
      <div class="visualizer">
        <div class="lfo-display">
          <canvas id="lfo-canvas"></canvas>
        </div>
      </div>
    </div>

    <!-- Performance Metrics -->
    <div class="panel">
      <h2>üìà Modulation Metrics</h2>
      <div class="metrics">
        <div class="metric">
          <div class="metric-value" id="metric-slots">0 / 16</div>
          <div class="metric-label">Active Modulation Slots</div>
        </div>
        <div class="metric">
          <div class="metric-value" id="metric-lfo">0.00 Hz</div>
          <div class="metric-label">LFO Frequency</div>
        </div>
        <div class="metric">
          <div class="metric-value" id="metric-cutoff">800 Hz</div>
          <div class="metric-label">Current Filter Cutoff</div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // Simplified inline modulation demo
    // In production, this would import from actual modules

    let audioContext = null;
    let masterGain = null;
    let filter = null;
    let lfo = null;
    let lfoGain = null;
    let oscillator = null;

    let isPlaying = false;
    let animationId = null;

    // LFO parameters
    let lfoRate = 2.0;
    let lfoDepth = 0.8;
    let lfoWaveform = 'sine';
    let filterBase = 800;
    let modAmount = 3000;
    let filterRes = 8;

    const log = (msg) => console.log(`[Modulation Demo] ${msg}`);

    // Initialize
    document.getElementById('init-btn').addEventListener('click', () => {
      try {
        log('Initializing modulation demo...');

        audioContext = new AudioContext();
        masterGain = audioContext.createGain();
        masterGain.gain.value = 0.3;
        masterGain.connect(audioContext.destination);

        log('‚úÖ AudioContext ready!');

        document.getElementById('init-btn').disabled = true;
        document.querySelectorAll('button:not(#init-btn):not(#stop-wobble-btn)').forEach(btn => btn.disabled = false);
        document.querySelectorAll('input, select').forEach(input => input.disabled = false);

        startVisualization();

        log('üéπ Ready! Click "Start Wobble Bass" to hear the magic!');

      } catch (error) {
        console.error('Error:', error);
      }
    });

    // Start wobble
    document.getElementById('start-wobble-btn').addEventListener('click', () => {
      if (isPlaying) return;

      log('Starting wobble bass...');

      // Create oscillator (bass note)
      oscillator = audioContext.createOscillator();
      oscillator.type = 'sawtooth';
      oscillator.frequency.value = 55; // A1 (bass note)

      // Create filter
      filter = audioContext.createBiquadFilter();
      filter.type = 'lowpass';
      filter.frequency.value = filterBase;
      filter.Q.value = filterRes;

      // Create LFO
      lfo = audioContext.createOscillator();
      lfo.type = lfoWaveform;
      lfo.frequency.value = lfoRate;

      // LFO gain (modulation depth)
      lfoGain = audioContext.createGain();
      lfoGain.gain.value = modAmount * lfoDepth;

      // Connect: LFO ‚Üí LFO Gain ‚Üí Filter Frequency
      lfo.connect(lfoGain);
      lfoGain.connect(filter.frequency);

      // Connect: Oscillator ‚Üí Filter ‚Üí Master Gain
      oscillator.connect(filter);
      filter.connect(masterGain);

      // Start
      oscillator.start();
      lfo.start();

      isPlaying = true;
      document.getElementById('start-wobble-btn').disabled = true;
      document.getElementById('start-wobble-btn').classList.add('playing');
      document.getElementById('stop-wobble-btn').disabled = false;

      log('üîä WOBBLE ACTIVATED!');
    });

    // Stop wobble
    document.getElementById('stop-wobble-btn').addEventListener('click', () => {
      if (!isPlaying) return;

      log('Stopping wobble...');

      if (oscillator) oscillator.stop();
      if (lfo) lfo.stop();

      isPlaying = false;
      document.getElementById('start-wobble-btn').disabled = false;
      document.getElementById('start-wobble-btn').classList.remove('playing');
      document.getElementById('stop-wobble-btn').disabled = true;

      log('‚è∏Ô∏è  Stopped');
    });

    // Presets
    document.getElementById('preset-slow').addEventListener('click', () => {
      document.getElementById('lfo-rate').value = 1;
      document.getElementById('lfo-depth').value = 90;
      document.getElementById('filter-base').value = 600;
      document.getElementById('mod-amount').value = 2500;
      updateAllSliders();
      applyLFOChanges();
      log('Preset: Slow Wobble');
    });

    document.getElementById('preset-medium').addEventListener('click', () => {
      document.getElementById('lfo-rate').value = 2;
      document.getElementById('lfo-depth').value = 80;
      document.getElementById('filter-base').value = 800;
      document.getElementById('mod-amount').value = 3000;
      updateAllSliders();
      applyLFOChanges();
      log('Preset: Medium Wobble');
    });

    document.getElementById('preset-fast').addEventListener('click', () => {
      document.getElementById('lfo-rate').value = 4;
      document.getElementById('lfo-depth').value = 70;
      document.getElementById('filter-base').value = 1000;
      document.getElementById('mod-amount').value = 3500;
      updateAllSliders();
      applyLFOChanges();
      log('Preset: Fast Wobble');
    });

    document.getElementById('preset-triplet').addEventListener('click', () => {
      document.getElementById('lfo-rate').value = 3;
      document.getElementById('lfo-depth').value = 85;
      document.getElementById('filter-base').value = 700;
      document.getElementById('mod-amount').value = 2800;
      updateAllSliders();
      applyLFOChanges();
      log('Preset: Triplet Wobble');
    });

    // Sliders
    document.getElementById('lfo-rate').addEventListener('input', (e) => {
      lfoRate = parseFloat(e.target.value);
      document.getElementById('lfo-rate-val').textContent = `${lfoRate.toFixed(1)} Hz`;
      applyLFOChanges();
    });

    document.getElementById('lfo-depth').addEventListener('input', (e) => {
      lfoDepth = parseFloat(e.target.value) / 100;
      document.getElementById('lfo-depth-val').textContent = `${e.target.value}%`;
      applyLFOChanges();
    });

    document.getElementById('lfo-wave').addEventListener('change', (e) => {
      lfoWaveform = e.target.value;
      document.getElementById('lfo-wave-val').textContent = e.target.value.charAt(0).toUpperCase() + e.target.value.slice(1);

      // Recreate LFO with new waveform if playing
      if (isPlaying) {
        recreateLFO();
      }
    });

    document.getElementById('filter-base').addEventListener('input', (e) => {
      filterBase = parseFloat(e.target.value);
      document.getElementById('filter-base-val').textContent = `${Math.round(filterBase)} Hz`;
      if (filter) filter.frequency.value = filterBase;
    });

    document.getElementById('mod-amount').addEventListener('input', (e) => {
      modAmount = parseFloat(e.target.value);
      document.getElementById('mod-amount-val').textContent = `+${Math.round(modAmount)} Hz`;
      applyLFOChanges();
    });

    document.getElementById('filter-res').addEventListener('input', (e) => {
      filterRes = parseFloat(e.target.value);
      document.getElementById('filter-res-val').textContent = filterRes.toFixed(1);
      if (filter) filter.Q.value = filterRes;
    });

    function applyLFOChanges() {
      if (!isPlaying) return;

      if (lfo) {
        lfo.frequency.setValueAtTime(lfoRate, audioContext.currentTime);
      }

      if (lfoGain) {
        lfoGain.gain.setValueAtTime(modAmount * lfoDepth, audioContext.currentTime);
      }
    }

    function recreateLFO() {
      if (!isPlaying || !lfo) return;

      log(`Changing waveform to: ${lfoWaveform}`);

      // Disconnect old LFO
      lfo.disconnect();
      lfo.stop();

      // Create new LFO with updated waveform
      lfo = audioContext.createOscillator();
      lfo.type = lfoWaveform;
      lfo.frequency.value = lfoRate;

      // Reconnect
      lfo.connect(lfoGain);

      // Start immediately
      lfo.start();

      log(`‚úÖ LFO recreated with ${lfoWaveform} waveform`);
    }

    function updateAllSliders() {
      document.querySelectorAll('input[type="range"], select').forEach(el => {
        el.dispatchEvent(new Event(el.tagName === 'SELECT' ? 'change' : 'input'));
      });
    }

    // Visualization
    const canvas = document.getElementById('lfo-canvas');
    const ctx = canvas.getContext('2d');

    function startVisualization() {
      function draw() {
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;

        ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (isPlaying && audioContext) {
          // Draw LFO waveform
          const now = audioContext.currentTime;
          const period = 1 / lfoRate;
          const points = 200;

          ctx.strokeStyle = '#ee0979';
          ctx.lineWidth = 3;
          ctx.beginPath();

          for (let i = 0; i < points; i++) {
            const t = (i / points) * period;
            const phase = (t / period) * 2 * Math.PI;

            let value = 0;
            if (lfoWaveform === 'sine') {
              value = Math.sin(phase);
            } else if (lfoWaveform === 'triangle') {
              value = (2 / Math.PI) * Math.asin(Math.sin(phase));
            } else if (lfoWaveform === 'sawtooth') {
              value = 2 * (phase / (2 * Math.PI)) - 1;
            } else if (lfoWaveform === 'square') {
              value = Math.sin(phase) >= 0 ? 1 : -1;
            }

            const x = (i / points) * canvas.width;
            const y = canvas.height / 2 - (value * canvas.height * 0.4);

            if (i === 0) {
              ctx.moveTo(x, y);
            } else {
              ctx.lineTo(x, y);
            }
          }

          ctx.stroke();

          // Update metrics
          const currentCutoff = filterBase + (Math.sin((now * lfoRate * 2 * Math.PI)) * modAmount * lfoDepth);
          document.getElementById('metric-cutoff').textContent = `${Math.round(currentCutoff)} Hz`;
        }

        document.getElementById('metric-slots').textContent = isPlaying ? '1 / 16' : '0 / 16';
        document.getElementById('metric-lfo').textContent = `${lfoRate.toFixed(2)} Hz`;

        animationId = requestAnimationFrame(draw);
      }

      draw();
    }

    log('Demo loaded! Click Initialize to begin.');
  </script>
</body>
</html>
